<!DOCTYPE html>
<html>
   <head>
      <link rel="stylesheet" type = "text/css" href = "css/index.css">
      <meta charset="utf-8" />
      <meta name="format-detection" content="telephone=no" />
      <meta name="msapplication-tap-highlight" content="no" />
      <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
      <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src * data:" />
      <script type="text/javascript" src="cordova.js"></script>
      <script type="text/javascript" charset="utf-8" src="js/SQLitePlugin.js"></script>
      <script type="text/javascript">
         if (window.XMLHttpRequest)
         {
             xhttp = new XMLHttpRequest();
         }else{
            
             xhttp=new ActiveObject("Microsoft.XMLHTTP");
         }
         
         var counter = 0;  //Für Darstellung der richtigen Fragen und Antworten
         var quest = []; //Enthält alle Fragen
         var answers = []; //Enthält alle Antworten
         var keyAnswer = []; //Enthält den Namen der ausgelesen Fragen
         var xmlDoc; 
         var guiElement = []; //Enthält die guiElemente, welche mit den Antworten dargestellt werden
         var dependentQuestions = []; //Enthält die Information, ob eine Frage abhängig von einer anderen ist
         var db = window.openDatabase("xmldb.db", "1.0", "database", 1000000); //Datenbank
         document.addEventListener("deviceready", onDeviceReady, false);
         
         xhttp.onreadystatechange = function() {
             if (this.readyState == 4 && (this.status == 200 ) ) {
             getQuestions(this);
             }
         };
            
         xhttp.open("GET", "xml/odm.XML", true);
         
         xhttp.onLoad = function() {
         
             xmlDoc = xmlhttp.responseXML;
         }
         
         xhttp.send();
         
         
         function getQuestions(xml)
         {
             xmlDoc = xml.responseXML;
             var itemDefChildren = [];
             var questionChildren = [];
             var textQuestion = [];
             var childrenCodeListArray = [];
             var question = xmlDoc.getElementsByTagName('Question')[0];
             var translatedText = xmlDoc.getElementsByTagName('TranslatedText')[0];
             var itemDef = xmlDoc.getElementsByTagName('ItemDef');
             var codeList = xmlDoc.getElementsByTagName('CodeList')[0];
             var codeChildren = codeList.childNodes[1];
             var codeListArray = xmlDoc.getElementsByTagName('CodeList');
             
         
             //Region alle Fragen und guiElemente zur Darstellung aus XML auslesen
             for(var i = 0; i < itemDef.length; i++)
             {
         
                 itemDefChildren.push(itemDef[i].childNodes);
                 guiElement.push(itemDef[i].getAttribute("Comment"));
                 
         
             }
             
             for(var i = 0; i < itemDefChildren.length; i++)
             {
                 for(var j = 0; j < itemDefChildren[i].length; j++)
                    {             
                     if(itemDefChildren[i][j].toString() === question.toString())
                     {
                         questionChildren.push(itemDefChildren[i][j].childNodes);                                   
                     }
         
                 }
         
             }
         
         
             for(var i = 0; i < questionChildren.length; i++)
                 {
                     for(var j = 0; j < questionChildren[i].length; j++)
                     {
                         if(questionChildren[i][j].toString() === translatedText.toString())
                         {
                             textQuestion.push(questionChildren[i][j].childNodes);
                         }
                 }
         
             }
         
             for(var i = 0; i < textQuestion.length; i++)
             {
                 for(var j = 0; j < textQuestion[i].length; j++)
                 {             
                     quest.push(textQuestion[i][j].nodeValue);
                 }
         
             }
         
             //Endregion Fragen auslesen
         
         
             //Region Antwortmöglichkeitein für alle Fragen auslesen
             
             for(var i = 0; i < codeListArray.length ; i++)
             {
         
                 childrenCodeListArray.push(codeListArray[i].childNodes);
                 keyAnswer.push(codeListArray[i].getAttribute("Name"));
                 dependentQuestions.push(codeListArray[i].getAttribute("Comment"));
         
             }
         
             for (var i = 0; i < childrenCodeListArray.length; i++)
             {
                 var possibleAnswers = [];
                 for (var j = 0; j < childrenCodeListArray[i].length; j++)
                 {
                     if(childrenCodeListArray[i][j].toString() === codeChildren.toString())
                     {
         
                         possibleAnswers.push([childrenCodeListArray[i][j].getAttribute("CodedValue")]); 
         
                     }
         
                 }
                 answers[keyAnswer[i]] = [possibleAnswers];
             }
             //Endregion Antwortmöglichkeitein auslesen
         
             setHTML();
         
         }
          
         
         //Verändert das HTML Dokument mit den in qetQuestions() ausgelesenen Fragen und Antwortmöglichkeitein und stellt diese dar
         function setHTML() {
             
         if(counter>0){
         document.getElementById("answer").innerHTML ="";
         }
             
         document.getElementById("question").innerHTML = quest[counter];
         document.getElementById("alert").setAttribute("hidden","");
         
         
         for(var i = 0; i < answers[keyAnswer[counter]].length; i++)
         {
             for(var j = 0; j < answers[keyAnswer[counter]][i].length; j++)
             {
                 if(guiElement[counter] == "radio")
                 {
                     document.getElementById("answer").innerHTML += "<input id="+ guiElement[counter] + j +"' type=" + guiElement[counter] +" name='answer' value=" + answers[keyAnswer[counter]][i][j] +" />  <label id='value" + j + " class = 'answer''>" + answers[keyAnswer[counter]][i][j] + "</label> ";
         
                 }else if(guiElement[counter] == "number")
                 {
                     document.getElementById("answer").innerHTML += "<input id='"+ guiElement[counter] + j +"' type='" + guiElement[counter] +"' name='answer' value='" + answers[keyAnswer[counter]][i][j] + "'/>";
         
                 }
             }
         }
          
         }
          
         
         //Erstellt die Datenbank und eine leere Textdatei
         function onDeviceReady(){
          
         db.transaction(populateDB);
         
         function populateDB(tx){
         tx.executeSql('DROP TABLE answer ');
         tx.executeSql('CREATE TABLE IF NOT EXISTS answer (questionID TEXT, answer TEXT)');
         
         
          var fileName = 'myfile.txt';   
         var data = "";             
         window.resolveLocalFileSystemURL( cordova.file.externalRootDirectory, function( directoryEntry ) {
             directoryEntry.getFile(fileName, { create: true }, function( fileEntry ) {
                 fileEntry.createWriter( function( fileWriter ) {
                     fileWriter.onwriteend = function( result ) {
                         alert( 'done.' );
                     };
                     fileWriter.onerror = function( error ) {
                         alert( error );
                     };
                     fileWriter.write( data );
                 }, function( error ) { alert( error ); } );
             }, function( error ) {alert( error ); } );
         }, function( error ) { alert( error ); } );
          
          
         }
         
         }
          
         //Die Antworten des Patienten werden gespeichert, in die Textdatei geschrieben und die nächsten Fragen dargestellt
         function saveAnswer(){
         
         var element = document.getElementsByName('answer');
         var checkedelements = 0;
         var questionId = keyAnswer[counter];
          
         for (var i = 0; i < element.length; i++)
         {
             if(guiElement[counter] == "radio"){
                 if (element[i].checked)
                 {
                 var answer = element[i].value;
         
                  checkedelements++;
         
                 break;
                 }
             }else if(guiElement[counter] == "number") {
                 
                 if (element[i].value != "")
                     {
                         var answer = element[i].value;
                         checkedelements++;
                     }
                     
                 }
         
           
         }
             
             //Überprüfung ob die nächste Frage von der jetzigen Antwort abhängig ist
             //Counter wird entsprechend gesetzt, um die richtige Frage darzustellen
             if(dependentQuestions[(counter+1)] == "dependent")
         {
             if(answer == "Nein")
             {
                 for(i = counter+1; i < quest.length; i++)
                 {
                     if(dependentQuestions[i] == "")
                         {
                             counter = i;
                             break;
                         }
         else if (i === quest.length-1)
         {
         counter=quest.length;
         }
                     
                 }
                
             }else if(answer == "Ja"){
                      counter++;
                      
                 }
            
         }else
             {
                 counter++;
             }
             
            
         
         //Überprüfen, ob weitere Fragen vorhanden sind und dargestellt werden müssen
         if(counter < quest.length && checkedelements > 0)
         {
         insertDbData(answer, questionId);
                 setHTML();
         }else if (checkedelements == 0){
         
         document.getElementById("alert").removeAttribute("hidden");
         
         }else if (counter == quest.length) {
         insertDbData(answer, questionId);
         fetchData();
         
         document.getElementById("weiterButton").setAttribute("hidden","");
         document.getElementById("questions").setAttribute("hidden","");
         document.getElementById("thankyou").removeAttribute("hidden");
         
         }
          
         }
         
         //Befüllt die Datenbank mit den ausgewählten Antworten
         function insertDbData(answer, questionId){
         
         db.transaction(insertAnswer, errorCB, successCB);
             
                 function insertAnswer(tx){
                 tx.executeSql("INSERT INTO answer(questionID, answer) VALUES (?, ?)",[questionId, answer]);
         
                 }
         
                 function errorCB(err) {
                 alert("Es ist ein Fehler aufgetreten, bitte wenden Sie sich an einen Mitarbeiter");
                 }
         
                 function successCB() {
                  //alert("successInsert!");
                 }
         
         }
              
         //Schreibt den Inhalt der Datenbank in eine Textdatei
         function fetchData()
         {
         db.transaction(function(tx){
          
         tx.executeSql("select * from answer",[],function(tx,result){
            var len = result.rows;
          
            
            var fileName = 'myfile.txt';    
         var data = len;              
         window.resolveLocalFileSystemURL( cordova.file.externalRootDirectory, function( directoryEntry ) {
             directoryEntry.getFile(fileName, { create: true }, function( fileEntry ) {
                 fileEntry.createWriter( function( fileWriter ) {
                     fileWriter.onwriteend = function( result ) {
                         alert( 'done.' );
                     };
                     fileWriter.onerror = function( error ) {
                         alert( error );
                     };
                     fileWriter.write( data );
                 }, function( error ) { alert( error ); } );
             }, function( error ) {alert( error ); } );
         }, function( error ) { alert( error ); } );
          
         },errorCB);
         }, errorCB, successCB);
          
         function errorCB(err) {
         alert("Es ist ein Fehler aufgetreten, bitte wenden Sie sich an einen Mitarbeiter");
         }
         
         function successCB() {
         
         }
         
         }
         
      </script>
   </head>
   <body>
      <div class ="h1"> Patientenfragebogen </div>
      <div id="questions" class="question">
         <form id= "testForm" name = "question">
            <p id ="question"> </p>
            <div id = "answer"> </div>
            <div hidden id="alert">
               <label class="alert-missing-answer">Bitte wählen Sie eine Antwort aus</label>
            </div>
         </form>
      </div>
      <div hidden id="thankyou" class="thankyou">
         <p>Vielen Dank für Ihre Mitarbeit!</p>
      </div>
      <div id="weiterButton" class="button">
         <button type="submit" id="weiter" onclick="saveAnswer()">Weiter</button>
      </div>
   </body>
</html>